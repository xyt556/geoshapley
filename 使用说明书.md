# GeoShapley 交互式分析工具 - 使用说明书

## 目录
1. [简介](#简介)
2. [安装步骤](#安装步骤)
3. [快速开始](#快速开始)
4. [详细使用说明](#详细使用说明)
5. [功能特性](#功能特性)
6. [故障排除](#故障排除)
7. [常见问题](#常见问题)

---

## 简介

GeoShapley 交互式分析工具是一个基于 Streamlit 构建的 Web 应用程序，提供了直观的界面来分析机器学习模型中的空间效应。该工具允许用户：

- 上传和准备空间数据
- 训练机器学习模型
- 执行 GeoShapley 分析
- 可视化空间效应和特征贡献
- 计算空间变化系数（SVC）

### 什么是 GeoShapley？

GeoShapley 是一种基于博弈论的方法，用于测量机器学习模型中的空间效应。它将模型预测分解为：
- **主要效应**：非空间特征贡献
- **空间效应**：位置特定的贡献
- **空间交互效应**：特征与位置之间的交互作用

---

## 安装步骤

### 前置要求

- Python 3.7 或更高版本
- pip 包管理器

### 步骤 1：创建虚拟环境（推荐）

```bash
# Windows
python -m venv venv
venv\Scripts\activate

# Linux/Mac
python -m venv venv
source venv/bin/activate
```

### 步骤 2：安装依赖

```bash
# 安装基础依赖
pip install -r requirements.txt

# 安装完整功能所需的额外包
pip install streamlit
pip install "flaml[automl]"
pip install geopandas matplotlib seaborn jupyter

# 可选：用于 SVC 计算中的 GWR 平滑
pip install mgwr

# 可选：用于 GAM 平滑曲线
pip install pygam
```

### 步骤 3：安装 GeoShapley 包

```bash
pip install -e .
```

---

## 快速开始

### 1. 启动应用程序

```bash
streamlit run app.py
```

应用程序会自动在默认浏览器中打开，地址为 `http://localhost:8501`

### 2. 基本工作流程

1. **数据上传** → 上传 CSV 文件或使用示例数据
2. **模型训练** → 训练机器学习模型
3. **GeoShapley 分析** → 运行空间效应分析
4. **结果可视化** → 查看和下载结果

---

## 详细使用说明

### 页面 1：数据上传

#### 上传您的数据

1. 点击 **"Upload CSV File"** 按钮
2. 选择一个包含以下内容的 CSV 文件：
   - 特征列（预测变量）
   - 目标变量（要预测的内容）
   - 空间坐标列（例如：经度/纬度或 UTM_X/UTM_Y）

**或者**

勾选 **"Use Example Data (Seattle House Price Data)"** 使用示例数据

#### 配置您的数据

1. **选择目标变量（y）**：选择要预测的列
2. **选择任务类型**：
   - **Regression（回归）**：用于连续值（如房价、温度）
   - **Classification（分类）**：用于分类值（如是/否、类别）
3. **选择特征列**：选择所有预测变量列（不包括空间坐标）
4. **选择空间坐标列**：选择坐标列（必须放在最后）

**重要提示**：空间坐标列必须是数据集中的最后几列！

5. 点击 **"Prepare Data"** 按钮

#### 数据格式要求

- CSV 文件格式
- 空间坐标必须在最后几列
- 坐标列中不能有缺失值
- 特征和坐标为数值类型

---

### 页面 2：模型训练

#### 查看数据信息

页面显示：
- 样本数量
- 特征数量
- 空间坐标数量

#### 选择模型类型

**AutoML (FLAML)**（推荐）
- 自动选择最佳模型
- 支持多种算法（XGBoost、LightGBM、随机森林等）
- 设置训练时间预算（秒）

**Random Forest（随机森林）**
- 经典的集成方法
- 设置树的数量（10-500）
- 适用于大多数问题

**Neural Network (MLP)（神经网络）**
- 多层感知器
- 设置隐藏层结构（例如："100,50" 表示两个隐藏层）
- 适用于复杂的非线性关系

#### 配置训练参数

- **Test Set Ratio（测试集比例）**：用于测试的数据比例（默认：0.2）
- **Random Seed（随机种子）**：用于可重现性（默认：42）
- **模型特定参数**：如上所述

#### 训练模型

1. 点击 **"Start Training"** 按钮<!-- slide -->


2. 等待训练完成
3. 查看性能指标：
   - **R² Score（R² 分数）**（回归）或 **Accuracy（准确率）**（分类）
   - **MSE（均方误差）**（回归）

---

### 页面 3：GeoShapley 分析

#### 配置分析参数

**Background Data Method（背景数据方法）**
- **K-means Clustering（K-means 聚类）**：推荐，使用代表性样本
- **Random Sampling（随机采样）**：随机选择背景样本

**Background Data Size（背景数据大小）**：用作背景的样本数量（默认：100）
- 值越大 = 越准确但越慢
- 推荐：50-200 个样本

**Number of Parallel Jobs（并行任务数）**：
- -1 = 使用所有 CPU 核心（推荐）
- 正数 = 使用特定数量的核心

**Number of Spatial Coordinates (g)（空间坐标数量）**：
- 通常为 2（经度、纬度）
- 对于高维空间数据可以更多

**Analysis Sample Size（分析样本数）**：
- 要分析的样本数量（默认：100）
- 值越大 = 越全面但越慢
- 建议从 100 开始，根据需要增加

#### 运行分析

1. 点击 **"Start Analysis"** 按钮
2. 等待分析完成（可能需要几分钟）
3. 查看结果：
   - **Basic Statistics（基本统计）**：所有 GeoShapley 值的汇总统计
   - **Additivity Check（可加性检查）**：验证组件是否相加等于模型预测

---

### 页面 4：结果可视化

#### 可视化选项

**1. Summary Plot（汇总图）**
- SHAP 风格的汇总图，显示特征重要性
- 选项：
  - 包含交互效应（推荐）
  - 图像分辨率（DPI）
- 点击 **"Generate Summary Plot"**

**2. Partial Dependence Plot（部分依赖图）**
- 显示每个特征如何影响预测
- 选项：
  - 每行最大列数
  - 显示 GAM 平滑曲线（需要 pygam）
- 点击 **"Generate Partial Dependence Plot"**

**3. Contribution Bar Plot（贡献条形图）**
- 特征贡献的排名条形图
- 显示非空间与空间贡献
- 点击 **"Generate Contribution Bar Plot"**

**4. Summary Statistics Table（统计摘要表）**
- 详细的统计表
- 选项：
  - 包含交互效应
- 下载为 CSV

#### 空间变化系数（SVC）

**目的**：计算特征的位置特定系数

**配置**：
1. **Select Features（选择特征）**：选择要计算 SVC 的特征
2. **Coefficient Type（系数类型）**：
   - **raw**：原始系数（可能包含极值）
   - **gwr**：GWR 平滑系数（需要 mgwr 包，推荐）
3. **Include Primary Effects（包含主要效应）**：是否在系数中包含主要效应

**可视化选项**：
- **Scatter Plot（散点图）**：在坐标空间中显示 SVC 值
- **Heatmap（热力图）**：SVC 值的矩阵可视化
- **Statistical Plot（统计图）**：显示 SVC 分布的箱线图

**下载**：SVC 数据可以下载为 CSV

---

## 功能特性

### 主要功能

1. **用户友好界面**：无需编程，所有操作通过 GUI 完成
2. **多模型支持**：AutoML、随机森林、神经网络
3. **全面分析**：完整的 GeoShapley 分解
4. **丰富的可视化**：多种图表类型，提供不同见解
5. **导出功能**：将结果下载为 CSV 文件
6. **示例数据**：内置西雅图房价数据集用于测试

### 高级功能

- **并行处理**：利用多核 CPU 加速分析
- **背景数据优化**：K-means 聚类用于高效背景选择
- **空间平滑**：基于 GWR 的平滑用于 SVC 计算
- **可加性验证**：自动检查组件是否正确相加

---

## 故障排除

### 常见问题

#### 1. 应用程序无法启动

**问题**：`streamlit: command not found`

**解决方案**：
```bash
pip install streamlit
```

#### 2. 导入错误

**问题**：`ModuleNotFoundError: No module named 'geoshapley'`

**解决方案**：
```bash
pip install -e .
```

#### 3. AutoML 训练失败

**问题**：AutoML 显示警告或错误

**解决方案**：
```bash
pip install "flaml[automl]"
```

#### 4. 汇总图为空

**问题**：图表显示但没有数据

**解决方案**：
- 确保 GeoShapley 分析成功完成
- 检查数据是否正确准备
- 尝试重新生成图表

#### 5. SVC 计算失败

**问题**：使用 GWR 方法计算 SVC 时出错

**解决方案**：
```bash
pip install mgwr
```

#### 6. GAM 平滑不可用

**问题**：GAM 曲线选项不起作用

**解决方案**：
```bash
pip install pygam
```

#### 7. 内存错误

**问题**：大数据集出现内存不足错误

**解决方案**：
- 减少分析样本数
- 减少背景数据大小
- 使用更少的特征
- 关闭其他应用程序

#### 8. 性能缓慢

**问题**：分析时间过长

**解决方案**：
- 减少样本数
- 使用更少的特征
- 减少背景数据大小
- 使用并行处理（设置 n_jobs=-1）
- 使用更快的模型（随机森林而不是神经网络）

---

## 常见问题

### Q1：需要什么数据格式？

**A**：CSV 格式，包含：
- 特征列（数值型）
- 目标变量列
- 空间坐标列（必须是最后几列）
- 坐标中无缺失值

### Q2：可以使用多少个空间坐标？

**A**：通常为 2 个（经度/纬度），但工具支持最多 5 个。相应地设置 `g` 参数。

### Q3：原始系数和 GWR 系数有什么区别？

**A**：
- **原始**：直接计算，可能有极值
- **GWR**：地理加权回归平滑，产生更平滑、更可解释的结果

### Q4：分析需要多长时间？

**A**：取决于：
- 样本数量（最重要）
- 特征数量
- 背景数据大小
- 模型复杂度
- 通常 100 个样本需要 1-10 分钟

### Q5：可以使用自己训练的模型吗？

**A**：目前，工具在内部训练模型。对于自定义模型，您需要修改代码以加载预训练模型。

### Q6：支持哪些模型？

**A**：
- AutoML (FLAML) - 自动选择最佳
- 随机森林
- 神经网络 (MLP)
- 任何与 scikit-learn 接口兼容的模型

### Q7：可以分析分类问题吗？

**A**：可以！在准备数据时选择 "Classification" 作为任务类型。

### Q8：GeoShapley 值是什么意思？

**A**：
- **主要效应**：特征如何影响预测（不考虑位置）
- **空间效应**：位置本身如何影响预测
- **交互效应**：特征效应如何随位置变化

### Q9：如何解释汇总图？

**A**：
- 特征按重要性排名（从上到下）
- 颜色表示特征值（红色 = 高，蓝色 = 低）
- 水平位置显示对预测的影响
- 更宽的分布 = 更可变的影响

### Q10：可以保存分析结果吗？

**A**：可以！您可以下载：
- 统计摘要为 CSV
- SVC 系数为 CSV
- 可视化可以使用浏览器的保存图像功能保存

---

## 最佳实践建议

1. **从小开始**：先用 50-100 个样本测试工作流程
2. **使用示例数据**：先尝试西雅图房价示例
3. **检查数据质量**：确保坐标有效且特征为数值型
4. **使用 K-means**：K-means 聚类通常比随机采样效果更好
5. **并行处理**：始终使用 n_jobs=-1 以加快分析速度
6. **先试 AutoML**：在特定模型之前尝试 AutoML - 它通常能找到更好的解决方案
7. **解释结果**：查看可加性检查以确保分析正确
8. **导出结果**：下载重要结果以供进一步分析

---

## 支持和资源

### 文档
- GeoShapley GitHub: https://github.com/Ziqi-Li/geoshapley
- GeoShapley 论文: Li, Z. (2024). GeoShapley: A Game Theory Approach to Measuring Spatial Effects in Machine Learning Models

### 相关工具
- SHAP: https://github.com/slundberg/shap
- FLAML: https://github.com/microsoft/FLAML
- Streamlit: https://streamlit.io/

---

## 版本历史

- **v1.0**（当前）：初始版本，具有完整的 GeoShapley 分析功能

---

## 许可证

本工具按原样提供，用于研究和教育目的。有关详细信息，请参阅 GeoShapley 项目许可证。

---

## 联系方式

对于以下问题：
- **GeoShapley 库**：查看 GitHub 仓库
- **此应用程序**：查看故障排除部分或根据需要修改代码

---

**祝分析愉快！🌍📊**

